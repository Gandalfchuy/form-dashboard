<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DevCompany - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">

    <nav class="bg-indigo-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <span class="text-xl font-bold">Panel de Control</span>
            <div class="flex items-center gap-4">
                <span id="user-display" class="text-sm opacity-80"></span>
                <button onclick="logout()" class="bg-indigo-800 hover:bg-indigo-900 px-3 py-1 rounded text-sm transition">Cerrar Sesión</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Registros Recibidos</h2>
        
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mensaje</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="4" class="text-center py-4">Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        const pb = new PocketBase('https://144.217.15.204.nip.io');

        // 1. Protección de Ruta: Si no hay login, fuera.
        if (!pb.authStore.isValid) {
            window.location.href = 'login.html';
        } else {
            // Mostrar email del usuario logueado
            document.getElementById('user-display').textContent = pb.authStore.model.email;
            loadData();
        }

        // 2. Función de Logout
        function logout() {
            pb.authStore.clear();
            window.location.href = 'index.html';
        }

        // 3. Cargar datos de la colección
        async function loadData() {
            const tbody = document.getElementById('table-body');
            try {
                const records = await pb.collection('contacts').getFullList({
                    sort: '-created',
                });

                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay registros aún.</td></tr>';
                    return;
                }

                tbody.innerHTML = ''; // Limpiar loader
                records.forEach(record => {
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${new Date(record.created).toLocaleString()}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${record.name}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 hover:underline">
                                <a href="mailto:${record.email}">${record.email}</a>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-700 max-w-xs truncate">
                                ${record.message}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error al cargar datos (Revisa permisos o conexión).</td></tr>';
            }
        }
    </script>
</body>
</html>